# SetEnv APPLICATION_ENV production

# Options
# -------

Options -Indexes
Options -Multiviews

# Redirect HTTP -> HTTPS
# ----------------------

RewriteEngine On

# 1. When HTTPS_PORT is set
RewriteCond %{ENV:APPLICATION_ENV} !development [NC]
RewriteCond %{HTTPS} !on [NC]
RewriteCond %{ENV:HTTPS_PORT} . [NC]
RewriteRule (.*) https://%{SERVER_NAME}:%{ENV:HTTPS_PORT}/$1 [R,L]

# 2. Otherwise, don't specify port
RewriteCond %{ENV:APPLICATION_ENV} !development [NC]
RewriteCond %{HTTPS} !on [NC]
RewriteRule (.*) https://%{SERVER_NAME}/$1 [R,L]

# URL Rewriting
# -------------

# Project/news URLs: try cache first
RewriteRule ^img/projects/(.*)$ data/cache/projects/$1 [L]
RewriteRule ^img/news/(.*)$ data/cache/news/$1 [L]
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^data/cache/.*$ - [L]

# Favicon
RewriteRule ^favicon.ico$ img/favicon.ico

# Public files
RewriteRule ^(css|js|img)/.*$ - [L]

# Redirect to image service when file does't exist
RewriteRule ^data/cache/([^/]*)/([^@]+)@(\d+)x(\d+).jpg services/image.php?path=$1/$2.jpg&width=$3&height=$4
RewriteRule ^data/cache/([^/]*)/([^@]+)@(\d+)x.jpg$ services/image.php?path=$1/$2.jpg&width=$3

# Services
RewriteRule ^services/(.*)$ services/$1 [L]

# Views
RewriteRule ^/?$                      view.php?view=home [L]
RewriteRule ^agence/?$                view.php?view=agency [L]
RewriteRule ^agence/publications/?$   view.php?view=publications [L]
RewriteRule ^projets/?$               view.php?view=projects [L]
RewriteRule ^projets/(.+)$            view.php?view=project-details&id=$1 [L]
RewriteRule ^admin/?$                 views/admin/index.php [L]
RewriteRule ^admin/login$             views/admin/login.php [L]
RewriteRule ^admin/logout$            views/admin/logout.php [L]
RewriteRule ^admin/project/new$       views/admin/project.php?new=true [L]
RewriteRule ^admin/project/(.+)/edit$ views/admin/project.php?new=false&id=$1 [L]

RewriteCond %{ENV:REDIRECT_STATUS} !=200
RewriteRule ^(.*) views/404.php?page=$1 [L]

ErrorDocument 404 /views/404.php

# Caching
# -------

<IfModule mod_expires.c>
  ExpiresActive on
  ExpiresDefault "access plus 1 month"

  ExpiresByType text/cache-manifest "access plus 0 seconds"
  ExpiresByType application/json "access plus 0 seconds"
  ExpiresByType application/javascript "access plus 1 week"
  ExpiresByType text/javascript "access plus 1 week"

  ExpiresByType text/html "access plus 1 day"
  ExpiresByType image/css "access plus 1 week"
  ExpiresByType image/ico "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
</IfModule>
